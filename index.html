<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>| decide.engine |</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="background-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="decide.engine">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="decide.engine">
    <meta name="description" content="Voice-first decision engine">

    <style>
        /* =========================================
           CORE SYSTEM | KUTCH AUTOMATION
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-bg: #0a0a0a;
            --text-main: #f0f0f0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --accent-zomato: #cb202d;
            --accent-swiggy: #fc8019;
            --accent-blinkit: #f8cb46;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-bg);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }

        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        .main-slide {
            height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column; background: var(--brand-bg);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }

        .main-slide.prev { transform: translateY(-100%); }
        .main-slide.active { transform: translateY(0); z-index: 10; }
        .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header {
            padding: 20px; border-left: 3px solid var(--brand-orange); height: 70px;
            flex-shrink: 0; z-index: 10; display: flex; align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-family: var(--font-tech); font-size: 0.75rem; color: var(--brand-orange);
            letter-spacing: 1px; font-weight: 700; text-transform: uppercase;
        }

        .header-badge {
            font-family: var(--font-tech); font-size: 0.6rem; color: #666;
            background: #111; padding: 4px 10px; border-radius: 12px;
            border: 1px solid #333;
        }

        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; }

        .sub-slide {
            position: absolute; inset: 0; padding: 25px; display: flex; flex-direction: column;
            justify-content: center; opacity: 0; pointer-events: none; transform: translateX(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            overflow-y: auto;
        }

        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }
        .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1.2; letter-spacing: -1px; color: var(--brand-orange); }
        .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; line-height: 1.4; font-weight: 600; }
        
        .wiki-summary { 
            font-size: 0.95rem; color: #ccc; line-height: 1.7; 
            max-height: 45vh; overflow-y: auto; margin-bottom: 20px; 
            padding: 15px; background: #111; border-radius: 8px;
            border-left: 3px solid #333;
        }

        .wiki-meta {
            display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;
        }

        .meta-chip {
            font-family: var(--font-tech); font-size: 0.65rem;
            background: #111; color: #888; padding: 6px 12px;
            border-radius: 6px; border: 1px solid #333;
        }

        .role-label {
            font-family: var(--font-tech); font-size: 0.6rem; color: #000;
            background: var(--accent-go); padding: 4px 8px; border-radius: 4px;
            width: fit-content; margin-bottom: 15px; font-weight: bold;
        }

        .nav-hint {
            margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;
            font-family: var(--font-tech); font-size: 0.7rem; color: #666;
            display: flex; justify-content: space-between;
        }

        .input-group { 
            border: 1px solid #333; background: #111; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; min-height: 100px; max-height: 40vh; overflow-y: auto; 
        }
        
        .input-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 10px 0; font-family: var(--font-tech); font-size: 0.8rem; }
        .input-key { color: #888; text-transform: uppercase; }
        .input-val { color: var(--accent-go); font-weight: bold; text-align: right; }
        
        .final-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-weight: 600; text-align: center; font-size: 0.8rem; cursor: pointer; display: block; width: 100%; box-sizing: border-box; transition: opacity 0.3s; }
        .btn-full { grid-column: span 2; }
        
        /* Platform Buttons */
        .btn-amazon { background: #232f3e; border: none; color: #ff9900; }
        .btn-zomato { background: #cb202d; border: none; }
        .btn-blinkit { background: var(--accent-blinkit); color: #000; border: none; }
        .btn-wa { background: #25D366; color: #000; border: none; }
        .btn-pdf { background: #d32f2f; border: none; color: #fff; }
        .btn-yt { background: #ff0000; border: none; }
        
        .lobby-container { display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%; justify-content: center; }
        .cuisine-btn { background: #222; border: 1px solid #444; color: #888; padding: 20px; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; border-radius: 12px; transition: all 0.2s; }
        .cuisine-btn.selected { background: var(--brand-orange); color: #000; border-color: var(--brand-orange); }

        #search-input { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 15px; font-size: 1.2rem; border-radius: 8px; margin-bottom: 20px; outline: none; text-align: center; }
        
        .source-toggle { 
            display: flex; gap: 10px; margin-bottom: 20px; 
            justify-content: center; flex-wrap: wrap;
        }
        
        .source-chip { 
            padding: 8px 16px; border: 1px solid #333; border-radius: 20px; 
            font-size: 0.7rem; color: #666; font-family: var(--font-tech); 
            cursor: pointer; transition: all 0.2s;
        }
        
        .source-chip.active { 
            background: #333; color: var(--accent-go); 
            border-color: var(--accent-go); 
        }

        .loading-indicator {
            text-align: center; padding: 40px;
            font-family: var(--font-tech); color: #666;
            font-size: 0.9rem;
        }

        .loading-spinner {
            width: 40px; height: 40px; margin: 20px auto;
            border: 3px solid #333;
            border-top-color: var(--accent-go);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-box {
            background: #331111; border: 1px solid #661111;
            color: #ff6666; padding: 15px; border-radius: 8px;
            margin: 20px 0; font-size: 0.9rem;
        }

        .success-box {
            background: #113311; border: 1px solid #116611;
            color: #66ff66; padding: 15px; border-radius: 8px;
            margin: 20px 0; font-size: 0.9rem;
        }

        .link-card {
            background: #111; border: 1px solid #333;
            padding: 15px; border-radius: 8px; margin: 10px 0;
            cursor: pointer; transition: all 0.2s;
        }

        .link-card:active {
            background: #1a1a1a; border-color: var(--accent-go);
        }

        .link-title {
            font-weight: 600; color: var(--accent-go);
            margin-bottom: 5px; font-size: 0.95rem;
        }

        .link-desc {
            font-size: 0.8rem; color: #888;
            line-height: 1.4;
        }

        .action-buttons {
            display: grid; 
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-buttons .btn-yt {
            grid-column: span 2;
        }

        #depth-fill { position: fixed; right: 0; top: 0; bottom: 0; width: 4px; background: #333; z-index: 900; height: 0%; transition: height 0.05s linear; }
        
        .toast-msg { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #00e676; padding: 10px 20px; border: 1px solid #00e676; border-radius: 20px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; font-family: var(--font-tech); }
        .toast-msg.visible { opacity: 1; }

        #mic-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #444; z-index: 2000; cursor: pointer; }
        #mic-toggle.listening { border-color: var(--accent-go); box-shadow: 0 0 15px rgba(0,230,118,0.3); }
        #mic-toggle svg { fill: #666; width: 24px; }
    </style>
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div id="master-container"></div>
<div id="depth-fill"></div>
<div id="toast" class="toast-msg"></div>

<div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</div>

<script>
    /* =========================================
       KUTCH AUTOMATION | UNIVERSAL OS v48.0
       ENHANCED WITH AMAZON AFFILIATE & PDF EXPORT
       ========================================= */
    
    // ðŸ§  ENHANCED MULTI-SOURCE RESEARCH ENGINE
    const WIKI_ENGINE = {
        activeSource: "wiki",
        cache: new Map(),
        
        sources: {
            wiki: {
                name: "WIKIPEDIA",
                api: "https://en.wikipedia.org/w/api.php",
                icon: "ðŸ“š",
                description: "General knowledge encyclopedia"
            },
            travel: {
                name: "WIKIVOYAGE", 
                api: "https://en.wikivoyage.org/w/api.php",
                icon: "ðŸ—ºï¸",
                description: "Travel guides and destinations"
            },
            wikibooks: {
                name: "WIKIBOOKS",
                api: "https://en.wikibooks.org/w/api.php", 
                icon: "ðŸ“–",
                description: "Educational textbooks"
            },
            wikinews: {
                name: "WIKINEWS",
                api: "https://en.wikinews.org/w/api.php",
                icon: "ðŸ“°", 
                description: "News articles"
            }
        },

        async search(query, source = this.activeSource) {
            const cacheKey = `search_${source}_${query}`;
            if (this.cache.has(cacheKey)) {
                return this.cache.get(cacheKey);
            }

            try {
                const api = this.sources[source].api;
                const url = `${api}?origin=*&action=opensearch&search=${encodeURIComponent(query)}&limit=5&format=json`;
                
                const res = await fetch(url);
                if (!res.ok) throw new Error('Network response failed');
                
                const data = await res.json();
                
                const results = [];
                if (data[1] && data[1].length > 0) {
                    for (let i = 0; i < data[1].length; i++) {
                        results.push({
                            title: data[1][i],
                            description: data[2][i] || '',
                            url: data[3][i] || ''
                        });
                    }
                }
                
                this.cache.set(cacheKey, results);
                return results;
            } catch(e) {
                console.error('Search error:', e);
                return [];
            }
        },

        async getContext(title, source = this.activeSource) {
            const cacheKey = `context_${source}_${title}`;
            if (this.cache.has(cacheKey)) {
                return this.cache.get(cacheKey);
            }

            try {
                const api = this.sources[source].api;
                
                const url = `${api}?origin=*&action=query&prop=extracts|info|pageimages|categories&titles=${encodeURIComponent(title)}&exintro=1&explaintext=1&inprop=url&piprop=thumbnail&pithumbsize=300&cllimit=10&format=json`;
                
                const res = await fetch(url);
                if (!res.ok) throw new Error('Network response failed');
                
                const data = await res.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId === "-1") {
                    throw new Error('Page not found');
                }
                
                const page = pages[pageId];
                
                const linksUrl = `${api}?origin=*&action=query&prop=links&titles=${encodeURIComponent(title)}&pllimit=20&plnamespace=0&format=json`;
                const linksRes = await fetch(linksUrl);
                const linksData = await linksRes.json();
                const linksPage = linksData.query.pages[pageId];
                
                const context = {
                    title: page.title,
                    summary: page.extract || "No summary available.",
                    url: page.fullurl || '',
                    thumbnail: page.thumbnail ? page.thumbnail.source : null,
                    categories: page.categories ? page.categories.slice(0, 5).map(c => c.title.replace('Category:', '')) : [],
                    links: linksPage && linksPage.links ? linksPage.links.map(l => ({
                        name: l.title,
                        ns: l.ns
                    })) : [],
                    source: source,
                    sourceName: this.sources[source].name
                };
                
                this.cache.set(cacheKey, context);
                return context;
            } catch(e) {
                console.error('Context error:', e);
                return null;
            }
        }
    };

    // ðŸ’° AFFILIATE SYSTEM
    const AMZN_TAG = "decideos-21";
    
    function generateAmazonBookLink(topic) {
        const query = encodeURIComponent(`${topic} book`);
        return `https://www.amazon.in/s?k=${query}&tag=${AMZN_TAG}&linkCode=ll2`;
    }

    function openYouTubeSearch(topic) {
        const q = encodeURIComponent(topic + " explained");
        window.open(`https://www.youtube.com/results?search_query=${q}`, '_blank');
    }

    // ðŸ§  TRUTH DATABASES
    const PHONE_DATABASE = {
      "Poco F7": { attr: { camera: 6.0, gaming: 9.5, battery: 8.0, ui: 4.0 }, price: 29999 },
      "iQOO Neo 10R": { attr: { camera: 6.5, gaming: 9.0, battery: 7.5, ui: 5.0 }, price: 30999 },
      "Nothing 3a Pro": { attr: { camera: 8.0, gaming: 6.0, battery: 7.0, ui: 10.0 }, price: 27999 },
      "Samsung Galaxy F07": { attr: { camera: 6.0, gaming: 3.0, battery: 8.5, ui: 7.0 }, price: 7499 },
      "Realme Note 60": { attr: { camera: 5.0, gaming: 4.0, battery: 8.0, ui: 6.0 }, price: 7999 }
    };

    const FOOD_DATABASE = {
        "Paneer Butter Masala": { attr: { comfort: 9.5, heaviness: 9.0, speed: 4.0, health: 3.0 }, price: 240 },
        "Dal Makhani": { attr: { comfort: 9.8, heaviness: 9.5, speed: 3.0, health: 4.0 }, price: 220 },
        "Hakka Noodles": { attr: { comfort: 7.5, heaviness: 6.0, speed: 9.0, health: 3.0 }, price: 200 },
        "Lays Classic": { attr: { comfort: 8.0, heaviness: 2.0, speed: 10.0, health: 1.0 }, price: 20 },
        "Maggi Noodles": { attr: { comfort: 9.0, heaviness: 5.0, speed: 9.5, health: 2.0 }, price: 14 },
        "Amul Milk": { attr: { comfort: 5.0, heaviness: 3.0, speed: 10.0, health: 9.0 }, price: 30 },
        "Coke": { attr: { comfort: 6.0, heaviness: 1.0, speed: 10.0, health: 0.0 }, price: 40 },
        "Tech Notebook": { attr: { comfort: 2.0, heaviness: 0.0, speed: 10.0, health: 10.0 }, price: 50 },
        "Ball Pen Set": { attr: { comfort: 1.0, heaviness: 0.0, speed: 10.0, health: 10.0 }, price: 20 }
    };

    const CATEGORY_VECTORS = {
        "camera": { camera: 0.4 }, "gaming": { gaming: 0.4 },
        "comfort_food": { comfort: 0.45, heaviness: 0.20, speed: 0.10 },
        "study_fuel": { speed: 0.5, comfort: 0.4, health: -0.1 },  
        "mid_week": { speed: 0.6, health: 0.2, heaviness: -0.2 }, 
        "bistro": { speed: 0.5, comfort: 0.2 } 
    };

    const DEEP_LINKS = {
        zomato: { app: q => `intent://search?q=${q}#Intent;scheme=zomato;package=com.application.zomato;end`, web: q => `https://www.zomato.com/search?q=${q}` },
        blinkit: { app: q => `blinkit://`, web: q => `https://blinkit.com/s/?q=${encodeURIComponent(q)}` },
        amazon: { 
            app: q => `intent://www.amazon.in/s?k=${q}&tag=${AMZN_TAG}#Intent;scheme=https;package=in.amazon.mShop.android.shopping;end`, 
            web: q => `https://www.amazon.in/s?k=${q}&tag=${AMZN_TAG}` 
        }
    };

    const FALLBACK_MENU = {
      "smartphones": { label: "SMARTPHONES", categories: [{label: "BUDGET <10K", items: [{"name": "Samsung Galaxy F07"}, {"name": "Realme Note 60"}]}] },
      "food": { 
          label: "DINING & ESSENTIALS", 
          categories: [
              { label: "MEALS (ZOMATO)", type: "comfort_food", items: [{"name": "Dal Makhani"}, {"name": "Hakka Noodles"}] },
              { label: "STUDY FUEL (BLINKIT)", type: "study_fuel", items: [{"name": "Lays Classic"}, {"name": "Coke"}] },
              { label: "MID-WEEK CRISIS", type: "mid_week", items: [{"name": "Amul Milk"}, {"name": "Maggi Noodles"}] },
              { label: "NON-FOOD", type: "mid_week", items: [{"name": "Tech Notebook"}, {"name": "Ball Pen Set"}] }
          ] 
      },
      "research": { label: "RESEARCH ENGINE", categories: [] } 
    };

    let ENGINE_STATE = { 
        cuisines_detected: [], 
        items_detected: {}, 
        session_weights: {}, 
        active_filters: [], 
        research_history: [],
        research_nodes: [] // For PDF generation
    };
    let RAW_DATA = FALLBACK_MENU;
    let slideElements = [];
    let currentIdx = 0;

    async function boot() { renderLobby(); initVoice(); initSwipeSystem(); }

    /* =========================================
       PDF GENERATION ENGINE - ENHANCED HUMAN-READABLE FORMAT
       ========================================= */
    async function generateResearchPDF() {
        if (ENGINE_STATE.research_nodes.length === 0) {
            return showToast("NO RESEARCH TO EXPORT");
        }

        showToast("GENERATING PDF...");

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (2 * margin);
            const lineHeight = 6;
            
            // Watermark function
            const addWatermark = (pageNum, totalPages) => {
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text(`viadecide.com | Page ${pageNum} of ${totalPages}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
                
                // Timestamp
                const now = new Date();
                const timestamp = now.toLocaleString('en-IN', { 
                    dateStyle: 'medium', 
                    timeStyle: 'short',
                    timeZone: 'Asia/Kolkata' 
                });
                doc.setFontSize(6);
                doc.text(`Generated: ${timestamp}`, margin, pageHeight - 8);
            };

            let pageNum = 1;
            const totalPages = ENGINE_STATE.research_nodes.length + 1;

            // ========== TITLE PAGE ==========
            doc.setFontSize(28);
            doc.setTextColor(255, 103, 31);
            doc.text("RESEARCH JOURNEY", pageWidth / 2, 50, { align: 'center' });
            
            doc.setFontSize(11);
            doc.setTextColor(0, 200, 100);
            doc.text("Powered by decide.engine", pageWidth / 2, 62, { align: 'center' });
            
            // Info box
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.rect(margin + 10, 80, contentWidth - 20, 35);
            
            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60);
            doc.text(`Total Nodes: ${ENGINE_STATE.research_nodes.length}`, pageWidth / 2, 92, { align: 'center' });
            doc.text(`Source: ${ENGINE_STATE.research_nodes[0]?.sourceName || 'Wikipedia'}`, pageWidth / 2, 100, { align: 'center' });
            doc.text(`Export Date: ${new Date().toLocaleDateString('en-IN')}`, pageWidth / 2, 108, { align: 'center' });
            
            // CTA Box
            doc.setDrawColor(255, 103, 31);
            doc.setFillColor(255, 250, 245);
            doc.roundedRect(margin + 10, 135, contentWidth - 20, 50, 3, 3, 'FD');
            
            doc.setFontSize(14);
            doc.setTextColor(255, 103, 31);
            doc.text("Continue Your Research", pageWidth / 2, 152, { align: 'center' });
            
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text("Visit viadecide.com for intelligent decision tools", pageWidth / 2, 163, { align: 'center' });
            doc.text("Research â€¢ Compare â€¢ Decide", pageWidth / 2, 172, { align: 'center' });
            
            addWatermark(pageNum, totalPages);

            // ========== RESEARCH NODES - ONE PER PAGE ==========
            ENGINE_STATE.research_nodes.forEach((node, index) => {
                doc.addPage();
                pageNum++;
                
                let yPos = 25;
                
                // Node number badge - larger and cleaner
                doc.setFillColor(0, 200, 100);
                doc.circle(margin + 8, yPos + 3, 8, 'F');
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}`, margin + 8, yPos + 5, { align: 'center' });
                
                // Title - better formatting
                yPos += 2;
                doc.setFontSize(18);
                doc.setTextColor(255, 103, 31);
                doc.setFont(undefined, 'bold');
                const titleLines = doc.splitTextToSize(node.title, contentWidth - 25);
                doc.text(titleLines, margin + 20, yPos);
                yPos += (titleLines.length * 8) + 8;
                
                doc.setFont(undefined, 'normal');
                
                // Source and metadata line
                doc.setFontSize(8);
                doc.setTextColor(120, 120, 120);
                doc.text(`Source: ${node.sourceName}`, margin, yPos);
                yPos += 6;
                
                // Categories with better styling
                if (node.categories && node.categories.length > 0) {
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    const cats = node.categories.slice(0, 4).join(' â€¢ ');
                    const catLines = doc.splitTextToSize(cats, contentWidth);
                    doc.text(catLines, margin, yPos);
                    yPos += (catLines.length * 4.5) + 6;
                }
                
                // Elegant divider
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 12;
                
                // Summary - better readability
                doc.setFontSize(10);
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'normal');
                
                // Clean the summary text
                let summaryText = node.summary
                    .replace(/\s+/g, ' ')  // Normalize whitespace
                    .trim();
                
                // Split into paragraphs at sentence boundaries for better flow
                const maxCharsPerPage = 2200;
                if (summaryText.length > maxCharsPerPage) {
                    summaryText = summaryText.substring(0, maxCharsPerPage);
                    // Find last period
                    const lastPeriod = summaryText.lastIndexOf('.');
                    if (lastPeriod > maxCharsPerPage - 200) {
                        summaryText = summaryText.substring(0, lastPeriod + 1);
                    }
                }
                
                // Split text to fit width with proper spacing
                const lines = doc.splitTextToSize(summaryText, contentWidth);
                
                // Calculate available space
                const availableHeight = pageHeight - yPos - 35; // Leave space for footer
                const maxLines = Math.floor(availableHeight / lineHeight);
                
                // Render lines with proper spacing
                const displayLines = lines.slice(0, maxLines);
                displayLines.forEach((line, i) => {
                    if (yPos < pageHeight - 35) {
                        doc.text(line, margin, yPos);
                        yPos += lineHeight;
                    }
                });
                
                // Truncation notice if needed
                if (lines.length > maxLines) {
                    yPos += 4;
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.setFont(undefined, 'italic');
                    doc.text("... (content truncated for brevity)", margin, yPos);
                    doc.setFont(undefined, 'normal');
                }
                
                // Footer section with link
                if (node.url) {
                    const footerY = pageHeight - 22;
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text("Read full article:", margin, footerY);
                    
                    doc.setTextColor(0, 100, 200);
                    doc.setFont(undefined, 'italic');
                    const urlText = node.url.length > 60 ? node.url.substring(0, 60) + '...' : node.url;
                    doc.textWithLink(urlText, margin, footerY + 5, { url: node.url });
                    doc.setFont(undefined, 'normal');
                }
                
                addWatermark(pageNum, totalPages);
            });

            // Save PDF with better filename
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            const timeStr = now.toTimeString().slice(0, 5).replace(':', '');
            const filename = `research-journey-${dateStr}-${timeStr}.pdf`;
            doc.save(filename);
            
            showToast("PDF DOWNLOADED!");
            
        } catch (error) {
            console.error('PDF generation error:', error);
            showToast("PDF GENERATION FAILED");
        }
    }

    /* =========================================
       UI LOGIC
       ========================================= */
    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active";
        
        let html = `<div class="slide-header">
                        <span class="header-title">DECIDE OS v48.0</span>
                        <span class="header-badge">PDF EXPORT</span>
                    </div>
                    <div class="lobby-container"><h1 style="text-align:center">SELECT DOMAIN</h1><div style="display:grid; gap:15px;">`;
        
        for(let key in RAW_DATA) {
            const isSelected = ENGINE_STATE.cuisines_detected.includes(key) ? "selected" : "";
            html += `<button class="cuisine-btn ${isSelected}" onclick="toggleDomain('${key}', this)">${RAW_DATA[key].label}</button>`;
        }
        
        html += `</div><button class="btn btn-auto btn-full" style="margin-top:30px" onclick="handleStart()">NEXT &rarr;</button></div>`;
        section.innerHTML = html;
        container.appendChild(section);
        slideElements = [section];
        currentIdx = 0;
    }

    function toggleDomain(id, btn) {
        ENGINE_STATE.cuisines_detected = [id]; 
        document.querySelectorAll('.cuisine-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function handleStart() {
        if(ENGINE_STATE.cuisines_detected.length === 0) return showToast("SELECT DOMAIN");
        const domain = ENGINE_STATE.cuisines_detected[0];
        if(domain === "research") {
            ENGINE_STATE.research_nodes = []; // Reset research journey
            renderSearchSlide();
        }
        else { ENGINE_STATE.active_filters = []; renderSubLobby(domain); }
    }

    function renderSubLobby(domain) {
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];

        const section = document.createElement('section');
        section.className = "main-slide next"; 
        
        const title = domain === 'food' ? "AAJ KYA MANGVAAYEGE!" : "SELECT PRIORITY";
        const categories = RAW_DATA[domain].categories;

        let html = `<div class="slide-header"><span class="header-title">FILTER</span></div>
                    <div class="lobby-container">
                    <h1 style="text-align:center; text-transform:uppercase;">${title}</h1>
                    <div style="display:grid; gap:15px;">`;

        categories.forEach((cat, idx) => {
            html += `<button class="cuisine-btn" id="filter-btn-${idx}" onclick="toggleFilter('${cat.label}', ${idx})">${cat.label}</button>`;
        });

        html += `</div><button class="btn btn-auto btn-full" style="margin-top:30px" onclick="startHunt()">HUNT &rarr;</button></div>`;
        
        section.innerHTML = html;
        container.appendChild(section);
        slideElements.push(section); 
        goToSlide(1); 
    }

    function toggleFilter(label, idx) {
        const btn = document.getElementById(`filter-btn-${idx}`);
        if(ENGINE_STATE.active_filters.includes(label)) {
            ENGINE_STATE.active_filters = ENGINE_STATE.active_filters.filter(x => x !== label);
            btn.classList.remove('selected');
        } else {
            ENGINE_STATE.active_filters.push(label);
            btn.classList.add('selected');
        }
    }

    function startHunt() { 
        if(ENGINE_STATE.active_filters.length === 0) return showToast("SELECT AT LEAST ONE");
        ENGINE_STATE.session_weights = { camera:0.1, gaming:0.1, battery:0.1, ui:0.1, anc:0.1, sound:0.1, mic:0.1, latency:0.1, comfort:0.1, health:0.1, spice:0.1, speed:0.1, protein:0.1, heaviness:0.1, shareability:0.1 };
        buildDeck(); 
    }

    /* ðŸŸ¢ ENHANCED RESEARCH BRANCH */
    function renderSearchSlide() {
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];

        const section = document.createElement('section');
        section.className = "main-slide next";
        
        let sourcesHtml = '';
        for (let key in WIKI_ENGINE.sources) {
            const src = WIKI_ENGINE.sources[key];
            const active = key === WIKI_ENGINE.activeSource ? 'active' : '';
            sourcesHtml += `<span class="source-chip ${active}" onclick="setSource('${key}', this)" title="${src.description}">${src.icon} ${src.name}</span>`;
        }
        
        section.innerHTML = `<div class="slide-header">
                                <span class="header-title">RESEARCH ENGINE</span>
                                <span class="header-badge">NODES: ${ENGINE_STATE.research_nodes.length}</span>
                            </div>
                    <div class="lobby-container">
                        <div class="source-toggle">${sourcesHtml}</div>
                        <h1>TOPIC?</h1>
                        <input type="text" id="search-input" placeholder="Enter topic...">
                        <button class="btn btn-auto btn-full" onclick="executeSearch()">SEARCH</button>
                        ${ENGINE_STATE.research_nodes.length > 0 ? '<button class="btn btn-pdf btn-full" onclick="generateResearchPDF()">ðŸ“„ DOWNLOAD PDF</button>' : ''}
                    </div>`;
        
        container.appendChild(section);
        slideElements.push(section);
        goToSlide(1);
        
        setTimeout(() => {
            const input = document.getElementById('search-input');
            if (input) {
                input.focus();
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') executeSearch();
                });
            }
        }, 100);
    }

    function setSource(src, btn) {
        WIKI_ENGINE.activeSource = src;
        document.querySelectorAll('.source-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        
        const srcInfo = WIKI_ENGINE.sources[src];
        const input = document.getElementById('search-input');
        if (input) {
            input.placeholder = `${srcInfo.icon} ${srcInfo.description}...`;
        }
    }

    async function executeSearch() {
        const query = document.getElementById('search-input').value.trim();
        if(!query) return showToast("ENTER TOPIC");
        
        const container = document.getElementById('master-container');
        const loadingSlide = document.createElement('section');
        loadingSlide.className = "main-slide next";
        loadingSlide.innerHTML = `<div class="slide-header"><span class="header-title">SEARCHING...</span></div>
            <div class="sub-slide static">
                <div class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <p>Searching ${WIKI_ENGINE.sources[WIKI_ENGINE.activeSource].name}...</p>
                </div>
            </div>`;
        container.appendChild(loadingSlide);
        slideElements.push(loadingSlide);
        goToSlide(slideElements.length - 1);
        
        try {
            const results = await WIKI_ENGINE.search(query);
            
            if (!results || results.length === 0) {
                showErrorSlide("No results found. Try different keywords or switch sources.");
                return;
            }
            
            buildSearchResults(results, query);
            
        } catch (error) {
            console.error('Search error:', error);
            showErrorSlide("Search failed. Please check your connection and try again.");
        }
    }

    function buildSearchResults(results, originalQuery) {
        const container = document.getElementById('master-container');
        
        if (slideElements.length > 2) {
            container.removeChild(container.lastChild);
            slideElements.pop();
        }
        
        const resultsSlide = document.createElement('section');
        resultsSlide.className = "main-slide next";
        resultsSlide.dataset.mode = "research";
        
        let html = `<div class="slide-header">
                        <span class="header-title">RESULTS</span>
                        <span class="header-badge">${results.length} FOUND</span>
                    </div>
                    <div class="carousel-viewport">`;
        
        results.forEach((result, i) => {
            html += `<div class="sub-slide ${i === 0 ? 'opt-active' : 'opt-hidden'}" data-val="${result.title}">
                        <div class="role-label">${WIKI_ENGINE.sources[WIKI_ENGINE.activeSource].icon} ${WIKI_ENGINE.sources[WIKI_ENGINE.activeSource].name}</div>
                        <h1>${result.title}</h1>
                        <div class="primary-question">${result.description || 'Click to view details'}</div>
                        <div class="nav-hint">
                            <span>&larr; MORE RESULTS</span>
                            <span style="color:var(--accent-go)">VIEW DETAILS &darr;</span>
                        </div>
                    </div>`;
        });
        
        html += `</div>`;
        resultsSlide.innerHTML = html;
        container.appendChild(resultsSlide);
        slideElements.push(resultsSlide);
        goToSlide(slideElements.length - 1);
    }

    async function loadArticleDetails(title) {
        const container = document.getElementById('master-container');
        
        const loadingSlide = document.createElement('section');
        loadingSlide.className = "main-slide next";
        loadingSlide.innerHTML = `<div class="slide-header"><span class="header-title">LOADING...</span></div>
            <div class="sub-slide static">
                <div class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <p>Extracting context...</p>
                </div>
            </div>`;
        container.appendChild(loadingSlide);
        slideElements.push(loadingSlide);
        goToSlide(slideElements.length - 1);
        
        try {
            const context = await WIKI_ENGINE.getContext(title);
            
            if (!context) {
                showErrorSlide("Failed to load article. Please try again.");
                return;
            }
            
            // Add to research journey
            ENGINE_STATE.research_history.push({
                title: context.title,
                source: context.source,
                timestamp: Date.now()
            });
            
            // Add to nodes for PDF
            ENGINE_STATE.research_nodes.push(context);
            
            container.removeChild(container.lastChild);
            slideElements.pop();
            
            buildResearchDeck(context);
            
        } catch (error) {
            console.error('Load error:', error);
            showErrorSlide("Failed to load article. Please try again.");
        }
    }

    function buildResearchDeck(context) {
        const container = document.getElementById('master-container');
        
        const sumSlide = document.createElement('section');
        sumSlide.className = "main-slide next";
        sumSlide.dataset.mode = "research";
        
        let metaHtml = '';
        if (context.categories && context.categories.length > 0) {
            metaHtml = '<div class="wiki-meta">';
            context.categories.forEach(cat => {
                metaHtml += `<span class="meta-chip">${cat}</span>`;
            });
            metaHtml += '</div>';
        }
        
        const bookLink = generateAmazonBookLink(context.title);
        
        sumSlide.innerHTML = `<div class="slide-header">
                                <span class="header-title">ARTICLE</span>
                                <span class="header-badge">${context.sourceName}</span>
                            </div>
            <div class="carousel-viewport"><div class="sub-slide static">
                <div class="role-label">${WIKI_ENGINE.sources[context.source].icon} ${context.sourceName}</div>
                <h1>${context.title}</h1>
                ${metaHtml}
                <div class="wiki-summary">${context.summary}</div>
                <div class="action-buttons">
                    ${context.url ? `<button class="btn" onclick="window.open('${context.url}', '_blank')">FULL ARTICLE</button>` : ''}
                    <button class="btn btn-amazon" onclick="window.open('${bookLink}', '_blank')">ðŸ“š FIND BOOK</button>
                    <button class="btn btn-yt" onclick="openYouTubeSearch('${context.title}')">â–¶ WATCH ON YOUTUBE</button>
                </div>
                <button class="btn btn-pdf btn-full" onclick="generateResearchPDF()">ðŸ“„ DOWNLOAD PDF (${ENGINE_STATE.research_nodes.length} NODES)</button>
                <div class="nav-hint">
                    <span>UP: BACK</span>
                    <span style="color:var(--accent-go)">DOWN: ${context.links.length} LINKS</span>
                </div>
            </div></div>`;
        container.appendChild(sumSlide);
        slideElements.push(sumSlide);

        if (context.links && context.links.length > 0) {
            const linkSlide = document.createElement('section');
            linkSlide.className = "main-slide next";
            linkSlide.dataset.mode = "research";
            
            let html = `<div class="slide-header">
                            <span class="header-title">RELATED TOPICS</span>
                            <span class="header-badge">${context.links.length} LINKS</span>
                        </div><div class="carousel-viewport">`;
            
            context.links.forEach((link, i) => {
                html += `<div class="sub-slide ${i === 0 ? 'opt-active' : 'opt-hidden'}" data-val="${link.name}">
                            <div class="role-label">RELATED NODE</div>
                            <h1>${link.name}</h1>
                            <div class="primary-question">Explore this related topic</div>
                            <div class="nav-hint">
                                <span>&larr; MORE TOPICS</span>
                                <span style="color:var(--accent-go)">EXPLORE &darr;</span>
                            </div>
                         </div>`;
            });
            html += `</div>`;
            linkSlide.innerHTML = html;
            container.appendChild(linkSlide);
            slideElements.push(linkSlide);
        }
        
        goToSlide(slideElements.length - 2);
    }

    function showErrorSlide(message) {
        const container = document.getElementById('master-container');
        
        if (slideElements.length > 2 && slideElements[slideElements.length - 1].querySelector('.loading-indicator')) {
            container.removeChild(container.lastChild);
            slideElements.pop();
        }
        
        const errorSlide = document.createElement('section');
        errorSlide.className = "main-slide next";
        errorSlide.innerHTML = `<div class="slide-header"><span class="header-title">ERROR</span></div>
            <div class="sub-slide static">
                <div class="error-box">${message}</div>
                <button class="btn btn-full" onclick="goToSlide(Math.max(0, currentIdx - 1))">GO BACK</button>
                <button class="btn btn-full" onclick="location.reload()">RESTART</button>
            </div>`;
        container.appendChild(errorSlide);
        slideElements.push(errorSlide);
        goToSlide(slideElements.length - 1);
    }

    /* ðŸ”´ STANDARD BRANCH */
    function buildDeck() {
        const container = document.getElementById('master-container');
        while(container.children.length > 2) container.removeChild(container.lastChild);
        slideElements = slideElements.slice(0, 2); 

        const domain = ENGINE_STATE.cuisines_detected[0];
        const allCats = RAW_DATA[domain].categories;
        const targetCats = allCats.filter(c => ENGINE_STATE.active_filters.includes(c.label));

        let slides = [];
        targetCats.forEach(cat => {
            slides.push({ type: 'opt', title: cat.label, items: cat.items, catType: cat.type });
        });
        slides.push({ type: 'final' });

        slides.forEach((s, idx) => {
            const el = document.createElement('section');
            el.className = `main-slide next`;
            el.dataset.catType = s.catType;
            
            if(s.type === 'final') {
                el.innerHTML = `<div class="sub-slide static"><div class="input-group" id="final-list"></div>
                           <div class="final-actions">
                             <button class="btn btn-amazon" id="btn-amazon" onclick="redirect('amazon')">AMAZON</button>
                             <button class="btn btn-blinkit" id="btn-blinkit" onclick="redirect('blinkit')">BLINKIT</button>
                             <button class="btn btn-zomato" id="btn-zomato" onclick="redirect('zomato')">ZOMATO</button>
                             <button class="btn btn-auto btn-full" id="btn-auto" onclick="redirect('auto')">AUTO ROUTE</button>
                             <button class="btn btn-wa btn-full" onclick="sendWa()">WHATSAPP</button>
                             <button class="btn btn-full" onclick="location.reload()">HOME</button>
                           </div></div>`;
            } else {
                let html = `<div class="slide-header"><span class="header-title">${s.title}</span></div><div class="carousel-viewport">`;
                s.items.forEach((item, i) => {
                    html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${item.name}">
                             <div class="role-label">OPTION</div><h1>${item.name}</h1>
                             <div class="nav-hint"><span>SKIP</span><span style="color:var(--accent-go)">SELECT</span></div></div>`;
                });
                html += `</div>`;
                el.innerHTML = html;
            }
            container.appendChild(el);
            slideElements.push(el);
        });
        
        goToSlide(2); 
    }

    function resolvePlatform() {
        const text = Object.keys(ENGINE_STATE.items_detected).join(" ").toLowerCase();
        if (text.match(/iphone|samsung|phone|vivo|poco|iqoo|charger|buds|realme|xiaomi/)) return "amazon";
        if (text.match(/coke|chips|lays|milk|maggi|notebook|pen|eggs|bread|kurkure/)) return "blinkit";
        return "zomato";
    }

    /* =========================================
       UX PHYSICS ENGINE
       ========================================= */
    let touchStartX = 0, touchStartY = 0;

    function initSwipeSystem() {
        const doc = document;
        
        doc.addEventListener('touchstart', e => {
            const view = e.target.closest('.carousel-viewport');
            if(!view) return;
            touchStartX = e.touches[0].clientX; 
            touchStartY = e.touches[0].clientY;
        }, {passive: true});

        doc.addEventListener('touchmove', e => {
            const view = e.target.closest('.carousel-viewport');
            if(!view) return;
            const dy = e.touches[0].clientY - touchStartY;
            if(dy > 0 && Math.abs(dy) > Math.abs(e.touches[0].clientX - touchStartX)) {
                if (e.cancelable) e.preventDefault(); 
                document.getElementById('depth-fill').style.height = Math.min((dy/150)*100, 100) + '%';
            }
        }, {passive: false});

        doc.addEventListener('touchend', e => {
            const view = e.target.closest('.carousel-viewport');
            if(!view) return;
            
            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;
            document.getElementById('depth-fill').style.height = '0%';
            
            const mainSlide = view.closest('.main-slide');
            const mode = mainSlide.dataset.mode;
            const catType = mainSlide.dataset.catType;

            if(Math.abs(dy) > 80 && dy > 0) { 
                const activeSub = view.querySelector('.sub-slide.opt-active') || view.querySelector('.sub-slide.static');
                if(!activeSub) return;
                
                const val = activeSub.dataset.val;
                
                if(mode === "research" && val) {
                    loadArticleDetails(val);
                } else if (val) {
                    ENGINE_STATE.items_detected[val] = {qty:1};
                    if(catType && CATEGORY_VECTORS[catType]) {
                        const vec = CATEGORY_VECTORS[catType];
                        for(let k in vec) ENGINE_STATE.session_weights[k] = (ENGINE_STATE.session_weights[k]||0) + vec[k];
                    }
                    showToast("SELECTED");
                    goToSlide(currentIdx + 1);
                } else {
                    goToSlide(currentIdx + 1);
                }
            } 
            else if (dy < -80) {
                if(mode === "research") {
                    showToast("BACK");
                    goToSlide(currentIdx - 1);
                } else {
                    goToSlide(currentIdx - 1);
                }
            }
            else if(Math.abs(dx) > 60) { 
                const slides = Array.from(view.querySelectorAll('.sub-slide'));
                if(slides.length <= 1) return;
                
                const currIdx = slides.findIndex(s => s.classList.contains('opt-active'));
                if(currIdx === -1) return;

                slides[currIdx].classList.replace('opt-active', 'opt-hidden');
                const nextIdx = (currIdx + (dx < 0 ? 1 : -1) + slides.length) % slides.length;
                slides[nextIdx].classList.replace('opt-hidden', 'opt-active');
            }
        });
    }

    function goToSlide(idx) {
        if(idx < 0 || idx >= slideElements.length) return;
        slideElements[currentIdx].classList.replace('active', idx>currentIdx?'prev':'next');
        currentIdx = idx;
        slideElements[currentIdx].className = "main-slide active";
        if(slideElements[currentIdx].querySelector('#final-list')) updateFinal();
    }

    function calculateVerdict() {
        const domain = ENGINE_STATE.cuisines_detected[0];
        if(domain === "research") return null;
        
        let DB = (domain === 'smartphones') ? PHONE_DATABASE : FOOD_DATABASE;
        let scores = [];
        
        for (let name in DB) {
            let item = DB[name];
            let score = 0;
            for(let attr in item.attr) {
                let w = ENGINE_STATE.session_weights[attr] || 0;
                score += item.attr[attr] * w;
            }
            if(ENGINE_STATE.items_detected[name]) score += 10;
            scores.push({name, score, price: item.price});
        }
        scores.sort((a, b) => b.score - a.score);
        return scores[0]; 
    }

    function updateFinal() {
        const list = document.getElementById('final-list');
        const winner = calculateVerdict();
        
        if (winner) {
            list.innerHTML = `
            <div class="biz-card" style="border-color:var(--accent-go)">
                <span class="biz-tagline">TOP RECOMMENDATION</span>
                <div style="font-size:1.5rem; font-weight:800; margin:10px 0">${winner.name}</div>
                <p style="color:#aaa">Est. Price: â‚¹${winner.price}</p>
            </div>`;
            ENGINE_STATE.items_detected = {};
            ENGINE_STATE.items_detected[winner.name] = {qty:1};
        } else {
            let html = "";
            for(let k in ENGINE_STATE.items_detected) html+=`<div class="input-row"><span class="input-key">${k}</span><span class="input-val">READY</span></div>`;
            list.innerHTML = html || "Nothing Selected";
        }

        const mode = resolvePlatform();
        document.getElementById('btn-amazon').style.display = mode === 'amazon' ? 'block' : 'none';
        document.getElementById('btn-blinkit').style.display = mode === 'blinkit' ? 'block' : 'none';
        document.getElementById('btn-zomato').style.display = mode === 'zomato' ? 'block' : 'none';
    }

    function forceCopy(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(err => fallbackCopy(text));
        } else {
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; 
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try { document.execCommand('copy'); } catch (err) {}
        document.body.removeChild(textArea);
    }

    function redirect(type) {
        const item = Object.keys(ENGINE_STATE.items_detected)[0];
        if(!item) return showToast("NOTHING SELECTED");
        
        forceCopy(item);
        showToast("LINK COPIED");

        const autoMode = resolvePlatform();
        const mode = type === 'auto' ? autoMode : type;
        const target = DEEP_LINKS[mode];
        const q = encodeURIComponent(item);

        const start = Date.now();
        window.location.href = target.app(q);
        setTimeout(() => {
            if (Date.now() - start < 2500) window.location.href = target.web(q);
        }, 2000);
    }

    function sendWa() {
        const items = Object.keys(ENGINE_STATE.items_detected).join(', ');
        const text = encodeURIComponent(`DECISION: ${items}`);
        window.open(`https://wa.me/?text=${text}`);
    }

    function showToast(m) { 
        const t = document.getElementById('toast'); 
        t.innerText = m; 
        t.classList.add('visible'); 
        setTimeout(() => t.classList.remove('visible'), 2000); 
    }
    
    function toggleListenMode() {
        showToast("VOICE: NOT IMPLEMENTED");
    }
    
    function initVoice() { }

    boot();
</script>
</body>
</html>
