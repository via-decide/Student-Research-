<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>| decide.engine |</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0a0a0a" />
  <meta name="background-color" content="#0a0a0a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="decide.engine" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="decide.engine" />
  <meta name="description" content="Voice-first decision engine" />

  <style>
    :root {
      --brand-orange: #ff671f;
      --brand-bg: #0a0a0a;
      --text-main: #f0f0f0;
      --accent-go: #00e676;
      --accent-skip: #ff3333;
      --accent-zomato: #cb202d;
      --accent-swiggy: #fc8019;
      --accent-blinkit: #f8cb46;
      --font-tech: 'Courier New', monospace;
      --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background-color: var(--brand-bg);
      color: var(--text-main);
      font-family: var(--font-ui);
      overflow: hidden;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

    .main-slide {
      height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
      display: flex; flex-direction: column; background: var(--brand-bg);
      transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      will-change: transform;
    }

    .main-slide.prev { transform: translateY(-100%); }
    .main-slide.active { transform: translateY(0); z-index: 10; }
    .main-slide.next { transform: translateY(100%); z-index: 20; }

    .slide-header {
      padding: 18px 20px;
      border-left: 3px solid var(--brand-orange);
      height: 66px;
      flex-shrink: 0; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(180deg, rgba(10,10,10,0.96), rgba(10,10,10,0.75));
      backdrop-filter: blur(6px);
    }

    .header-title {
      font-family: var(--font-tech); font-size: 0.75rem; color: var(--brand-orange);
      letter-spacing: 1px; font-weight: 700; text-transform: uppercase;
    }

    .header-badge {
      font-family: var(--font-tech); font-size: 0.6rem; color: #777;
      background: #111; padding: 4px 10px; border-radius: 12px;
      border: 1px solid #2a3342;
    }

    .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; }

    .sub-slide {
      position: absolute; inset: 0;
      padding: 22px;
      display: flex; flex-direction: column;
      justify-content: center;
      opacity: 0; pointer-events: none; transform: translateX(20px);
      transition: transform 0.3s ease, opacity 0.3s ease;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
    .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }
    .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

    /* âœ… ARTICLE layout: top aligned + safe bottom padding so actions never feel clipped */
    .sub-slide.article-view {
      justify-content: flex-start;
      padding-top: 16px;
      padding-bottom: 170px; /* space for sticky action bar + mic */
    }

    h1 {
      font-size: 1.9rem;
      margin: 0 0 12px 0;
      line-height: 1.1;
      letter-spacing: -1px;
      color: var(--brand-orange);
    }
    .primary-question {
      font-size: 1.05rem; color: #fff;
      margin-bottom: 16px; line-height: 1.45; font-weight: 600;
    }

    /* ---------- CONTEXT FORMATTING ---------- */
    .context-panel{
      background:#0f1318;
      border:1px solid #2a3342;
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }
    .context-top {
      display:flex; gap:12px; align-items:flex-start; margin-bottom:12px;
    }
    .thumb {
      width:64px; height:64px; border-radius:14px;
      background:#111; border:1px solid #2a3342;
      flex:0 0 auto; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      color:#666; font-family:var(--font-tech); font-size:0.7rem;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .context-title-wrap{ flex:1; min-width:0; }
    .context-kicker{
      font-family:var(--font-tech); font-size:0.65rem; letter-spacing:1px;
      color:#9aa3b2; text-transform:uppercase;
      margin-bottom:6px;
    }
    .context-stats{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;
    }
    .stat-chip{
      font-family:var(--font-tech); font-size:0.65rem;
      background:#0b0f14; color:#c0c7d6;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #2a3342;
    }

    .wiki-meta { display:flex; gap:8px; margin: 10px 0 6px; flex-wrap:wrap; }
    .meta-chip {
      font-family: var(--font-tech); font-size: 0.65rem;
      background: #0b0f14; color: #c0c7d6; padding: 6px 10px;
      border-radius: 999px; border: 1px solid #2a3342;
    }

    .section-title{
      font-family: var(--font-tech);
      font-size: 0.7rem;
      color:#9aa3b2;
      letter-spacing:1px;
      text-transform:uppercase;
      margin: 10px 0 8px;
    }

    /* âœ… Compact takeaways to prevent layout break */
    .takeaways{
      background:#0b0f14;
      border:1px solid #2a3342;
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:12px;

      max-height: 24vh;
      overflow-y:auto;

      touch-action: pan-y;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    .takeaways ul{ margin: 8px 0 0 18px; padding:0; }
    .takeaways li{
      color:#d6dde8;
      line-height:1.55;
      margin:6px 0;
      font-size:0.95rem;
    }

    .wiki-summary{
      font-size:0.98rem;
      color:#d6dde8;
      line-height:1.75;

      max-height: 36vh; /* more predictable on mobile */
      overflow-y:auto;

      padding: 14px;
      background: #0b0f14;
      border-radius: 12px;
      border: 1px solid #2a3342;

      touch-action: pan-y;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    .wiki-summary p{ margin: 0 0 12px 0; }
    .wiki-summary p:last-child{ margin-bottom:0; }
    .wiki-summary .lead{
      color:#ffffff;
      font-weight:800;
      margin-bottom:12px;
    }
    .wiki-summary .muted{ color:#a8b3c2; }

    .role-label {
      font-family: var(--font-tech); font-size: 0.6rem; color: #000;
      background: var(--accent-go); padding: 4px 8px; border-radius: 6px;
      width: fit-content; margin-bottom: 12px; font-weight: 800;
    }

    .nav-hint {
      margin-top: 14px; padding-top: 12px; border-top: 1px solid #222a36;
      font-family: var(--font-tech); font-size: 0.7rem; color: #666;
      display: flex; justify-content: space-between;
    }

    .input-group {
      border: 1px solid #333; background: #111; padding: 20px; border-radius: 8px;
      margin-bottom: 20px; min-height: 100px; max-height: 40vh; overflow-y: auto;
    }

    .input-row { display:flex; justify-content:space-between; border-bottom:1px dashed #333; padding:10px 0; font-family:var(--font-tech); font-size:0.8rem; }
    .input-key { color:#888; text-transform:uppercase; }
    .input-val { color:var(--accent-go); font-weight:bold; text-align:right; }

    .final-actions { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px; }

    .btn {
      background:#1c1c1c;
      color:#fff;
      border:1px solid #2a3342;
      padding:14px 14px;
      border-radius:12px;
      font-weight:700;
      text-align:center;
      font-size:0.82rem;
      cursor:pointer;
      display:block;
      width:100%;
      box-sizing:border-box;
      transition: transform 0.12s ease, opacity 0.2s ease;
    }
    .btn:active { transform: scale(0.99); opacity: 0.95; }
    .btn-full { grid-column: span 2; }

    .btn-amazon { background:#232f3e; border:none; color:#ff9900; }
    .btn-zomato { background:#cb202d; border:none; }
    .btn-blinkit { background:var(--accent-blinkit); color:#000; border:none; }
    .btn-wa { background:#25D366; color:#000; border:none; }
    .btn-pdf { background:#d32f2f; border:none; color:#fff; }
    .btn-yt { background:#ff0000; border:none; }

    .lobby-container { display:flex; flex-direction:column; gap:15px; padding:30px; height:100%; justify-content:center; }
    .cuisine-btn {
      background:#161616; border:1px solid #2a3342; color:#c0c7d6;
      padding:18px; font-size:1.05rem;
      font-weight:800; text-transform:uppercase; border-radius:14px;
      transition:all 0.2s;
    }
    .cuisine-btn.selected { background: var(--brand-orange); color:#000; border-color: var(--brand-orange); }

    #search-input {
      width:100%;
      background:#0b0f14;
      border:1px solid #2a3342;
      color:#fff;
      padding:14px;
      font-size:1.05rem;
      border-radius:12px;
      margin-bottom:14px;
      outline:none;
      text-align:center;
    }

    .source-toggle { display:flex; gap:10px; margin-bottom:18px; justify-content:center; flex-wrap:wrap; }
    .source-chip {
      padding:8px 14px;
      border:1px solid #2a3342;
      border-radius:999px;
      font-size:0.7rem;
      color:#9aa3b2;
      font-family: var(--font-tech);
      cursor:pointer;
      transition: all 0.2s;
      background:#0b0f14;
    }
    .source-chip.active { background:#121a24; color:var(--accent-go); border-color: var(--accent-go); }

    .loading-indicator { text-align:center; padding:40px; font-family:var(--font-tech); color:#666; font-size:0.9rem; }
    .loading-spinner {
      width:40px; height:40px; margin:20px auto;
      border:3px solid #2a3342; border-top-color: var(--accent-go);
      border-radius:50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-box {
      background:#331111; border:1px solid #661111;
      color:#ff6666; padding:15px; border-radius:12px;
      margin:20px 0; font-size:0.9rem;
    }

    /* âœ… Sticky action bar for article: keeps actions reachable */
    .action-bar {
      position: sticky;
      bottom: 0;
      margin-top: 14px;
      padding-top: 10px;
      background: linear-gradient(180deg, rgba(10,10,10,0), rgba(10,10,10,0.92) 40%, rgba(10,10,10,0.98));
      backdrop-filter: blur(6px);
    }
    .action-buttons {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom: 10px;
    }
    .action-buttons .btn-yt { grid-column: span 2; }

    #depth-fill { position: fixed; right:0; top:0; bottom:0; width:4px; background:#333; z-index:900; height:0%; transition: height 0.05s linear; }

    .toast-msg {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: #0b0f14; color: #00e676; padding: 10px 18px;
      border: 1px solid #00e676;
      border-radius: 999px; font-size: 0.8rem; opacity: 0; pointer-events: none;
      transition: opacity 0.25s; z-index: 3000; font-family: var(--font-tech);
    }
    .toast-msg.visible { opacity: 1; }

    #mic-toggle {
      position: fixed; bottom: 20px; left: 20px;
      width: 52px; height: 52px;
      background: #0b0f14;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      border: 1px solid #2a3342; z-index: 2000; cursor: pointer;
      box-shadow: 0 12px 24px rgba(0,0,0,0.35);
    }
    #mic-toggle.listening { border-color: var(--accent-go); box-shadow: 0 0 18px rgba(0,230,118,0.25); }
    #mic-toggle svg { fill: #9aa3b2; width: 24px; }

    /* Reduce accidental selection while still allowing scroll in panels */
    .wiki-summary, .takeaways { user-select: text; -webkit-user-select: text; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
  <div id="master-container"></div>
  <div id="depth-fill"></div>
  <div id="toast" class="toast-msg"></div>

  <div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
  </div>

<script>
/* =========================================
   DECIDE OS v49.0
   - Stable mobile UI for ARTICLE view
   - Swipe guard for scroll panels
   - Robust API fetch (timeout + safe parsing)
   ========================================= */

/* ---------- robust fetch helpers ---------- */
async function fetchJSON(url, { timeoutMs = 9000 } = {}) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } finally {
    clearTimeout(t);
  }
}

/* ---------- HTML helpers ---------- */
function escapeHTML(str){
  return (str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normalizeText(text){
  return (text || "")
    .replace(/\s+/g, " ")
    .replace(/\u00AD/g, "")
    .trim();
}
function isNoSummary(summary){
  const s = normalizeText(summary || "").toLowerCase();
  return !s || s === "no summary available." || s === "no summary available";
}
function splitIntoSentences(text){
  const t = normalizeText(text);
  if(!t) return [];
  return t.split(/(?<=[.!?])\s+(?=[A-Z0-9"â€œ(])/g).map(s => s.trim()).filter(Boolean);
}
function extractTakeaways(summary, max = 4){
  const s = splitIntoSentences(summary);
  return s.slice(0, max).map(x => x.replace(/\s+/g, " ").trim());
}
function formatSummaryHTML(summary){
  const sents = splitIntoSentences(summary);
  if(sents.length === 0) return `<p class="muted">No summary available.</p>`;
  const lead = sents[0];
  const rest = sents.slice(1);
  const paras = [];
  for(let i=0;i<rest.length;i+=3) paras.push(rest.slice(i, i+3).join(" "));
  return `<p class="lead">${escapeHTML(lead)}</p>` + paras.map(p => `<p>${escapeHTML(p)}</p>`).join("");
}
function wordCount(text){
  const t = normalizeText(text);
  if(!t) return 0;
  return t.split(/\s+/).length;
}
function readingTimeMins(words){
  return Math.max(1, Math.round(words / 180));
}

/* ---------- external actions ---------- */
const AMZN_TAG = "decideos-21";
function generateAmazonBookLink(topic) {
  const query = encodeURIComponent(`${topic} book`);
  return `https://www.amazon.in/s?k=${query}&tag=${AMZN_TAG}&linkCode=ll2`;
}
function openYouTubeSearch(topic) {
  const q = encodeURIComponent(topic + " explained");
  window.open(`https://www.youtube.com/results?search_query=${q}`, '_blank');
}
function openWikipedia(title){
  const q = encodeURIComponent(title);
  window.open(`https://en.wikipedia.org/wiki/Special:Search?search=${q}`, "_blank");
}

/* =========================================
   MULTI-SOURCE RESEARCH ENGINE
   ========================================= */
const WIKI_ENGINE = {
  activeSource: "wiki",
  cache: new Map(),

  sources: {
    wiki: { name: "WIKIPEDIA", api: "https://en.wikipedia.org/w/api.php", icon: "ðŸ“š", description: "General knowledge encyclopedia" },
    travel: { name: "WIKIVOYAGE", api: "https://en.wikivoyage.org/w/api.php", icon: "ðŸ—ºï¸", description: "Travel guides and destinations" },
    wikibooks: { name: "WIKIBOOKS", api: "https://en.wikibooks.org/w/api.php", icon: "ðŸ“–", description: "Educational textbooks" },
    wikinews: { name: "WIKINEWS", api: "https://en.wikinews.org/w/api.php", icon: "ðŸ“°", description: "News articles" }
  },

  async search(query, source = this.activeSource) {
    const q = normalizeText(query);
    const cacheKey = `search_${source}_${q}`;
    if (this.cache.has(cacheKey)) return this.cache.get(cacheKey);

    try {
      const api = this.sources[source].api;
      const url = `${api}?origin=*&action=opensearch&search=${encodeURIComponent(q)}&limit=8&format=json`;
      const data = await fetchJSON(url);

      const results = [];
      if (data && data[1] && data[1].length > 0) {
        for (let i = 0; i < data[1].length; i++) {
          results.push({
            title: data[1][i],
            description: (data[2] && data[2][i]) ? data[2][i] : '',
            url: (data[3] && data[3][i]) ? data[3][i] : ''
          });
        }
      }
      this.cache.set(cacheKey, results);
      return results;
    } catch(e) {
      console.error("Search error:", e);
      return [];
    }
  },

  async getContext(title, source = this.activeSource) {
    const t = normalizeText(title);
    const cacheKey = `context_${source}_${t}`;
    if (this.cache.has(cacheKey)) return this.cache.get(cacheKey);

    try {
      const api = this.sources[source].api;

      const url =
        `${api}?origin=*&action=query&prop=extracts|info|pageimages|categories` +
        `&titles=${encodeURIComponent(t)}` +
        `&exintro=1&explaintext=1&inprop=url` +
        `&piprop=thumbnail&pithumbsize=300` +
        `&cllimit=10&format=json`;

      const data = await fetchJSON(url);
      const pages = data?.query?.pages || {};
      const firstKey = Object.keys(pages)[0];
      if (!firstKey || firstKey === "-1") throw new Error("Page not found");
      const page = pages[firstKey];

      // links call (robust parse)
      const linksUrl =
        `${api}?origin=*&action=query&prop=links&titles=${encodeURIComponent(t)}` +
        `&pllimit=20&plnamespace=0&format=json`;

      let links = [];
      try {
        const linksData = await fetchJSON(linksUrl);
        const lp = linksData?.query?.pages || {};
        const lk = Object.keys(lp)[0];
        links = (lk && lp[lk] && lp[lk].links) ? lp[lk].links.map(l => ({ name: l.title, ns: l.ns })) : [];
      } catch(e) {
        links = [];
      }

      const context = {
        title: page.title,
        summary: page.extract || "No summary available.",
        url: page.fullurl || "",
        thumbnail: page.thumbnail ? page.thumbnail.source : null,
        categories: page.categories ? page.categories.slice(0,5).map(c => c.title.replace("Category:","")) : [],
        links,
        source,
        sourceName: this.sources[source].name
      };

      this.cache.set(cacheKey, context);
      return context;
    } catch(e) {
      console.error("Context error:", e);
      return null;
    }
  }
};

/* =========================================
   TRUTH DATABASES (UNCHANGED)
   ========================================= */
const PHONE_DATABASE = {
  "Poco F7": { attr: { camera: 6.0, gaming: 9.5, battery: 8.0, ui: 4.0 }, price: 29999 },
  "iQOO Neo 10R": { attr: { camera: 6.5, gaming: 9.0, battery: 7.5, ui: 5.0 }, price: 30999 },
  "Nothing 3a Pro": { attr: { camera: 8.0, gaming: 6.0, battery: 7.0, ui: 10.0 }, price: 27999 },
  "Samsung Galaxy F07": { attr: { camera: 6.0, gaming: 3.0, battery: 8.5, ui: 7.0 }, price: 7499 },
  "Realme Note 60": { attr: { camera: 5.0, gaming: 4.0, battery: 8.0, ui: 6.0 }, price: 7999 }
};

const FOOD_DATABASE = {
  "Paneer Butter Masala": { attr: { comfort: 9.5, heaviness: 9.0, speed: 4.0, health: 3.0 }, price: 240 },
  "Dal Makhani": { attr: { comfort: 9.8, heaviness: 9.5, speed: 3.0, health: 4.0 }, price: 220 },
  "Hakka Noodles": { attr: { comfort: 7.5, heaviness: 6.0, speed: 9.0, health: 3.0 }, price: 200 },
  "Lays Classic": { attr: { comfort: 8.0, heaviness: 2.0, speed: 10.0, health: 1.0 }, price: 20 },
  "Maggi Noodles": { attr: { comfort: 9.0, heaviness: 5.0, speed: 9.5, health: 2.0 }, price: 14 },
  "Amul Milk": { attr: { comfort: 5.0, heaviness: 3.0, speed: 10.0, health: 9.0 }, price: 30 },
  "Coke": { attr: { comfort: 6.0, heaviness: 1.0, speed: 10.0, health: 0.0 }, price: 40 },
  "Tech Notebook": { attr: { comfort: 2.0, heaviness: 0.0, speed: 10.0, health: 10.0 }, price: 50 },
  "Ball Pen Set": { attr: { comfort: 1.0, heaviness: 0.0, speed: 10.0, health: 10.0 }, price: 20 }
};

const CATEGORY_VECTORS = {
  "camera": { camera: 0.4 }, "gaming": { gaming: 0.4 },
  "comfort_food": { comfort: 0.45, heaviness: 0.20, speed: 0.10 },
  "study_fuel": { speed: 0.5, comfort: 0.4, health: -0.1 },
  "mid_week": { speed: 0.6, health: 0.2, heaviness: -0.2 },
  "bistro": { speed: 0.5, comfort: 0.2 }
};

const DEEP_LINKS = {
  zomato: { app: q => `intent://search?q=${q}#Intent;scheme=zomato;package=com.application.zomato;end`, web: q => `https://www.zomato.com/search?q=${q}` },
  blinkit: { app: q => `blinkit://`, web: q => `https://blinkit.com/s/?q=${encodeURIComponent(q)}` },
  amazon: {
    app: q => `intent://www.amazon.in/s?k=${q}&tag=${AMZN_TAG}#Intent;scheme=https;package=in.amazon.mShop.android.shopping;end`,
    web: q => `https://www.amazon.in/s?k=${q}&tag=${AMZN_TAG}`
  }
};

const FALLBACK_MENU = {
  "smartphones": { label: "SMARTPHONES", categories: [{label: "BUDGET <10K", items: [{"name": "Samsung Galaxy F07"}, {"name": "Realme Note 60"}]}] },
  "food": {
    label: "DINING & ESSENTIALS",
    categories: [
      { label: "MEALS (ZOMATO)", type: "comfort_food", items: [{"name": "Dal Makhani"}, {"name": "Hakka Noodles"}] },
      { label: "STUDY FUEL (BLINKIT)", type: "study_fuel", items: [{"name": "Lays Classic"}, {"name": "Coke"}] },
      { label: "MID-WEEK CRISIS", type: "mid_week", items: [{"name": "Amul Milk"}, {"name": "Maggi Noodles"}] },
      { label: "NON-FOOD", type: "mid_week", items: [{"name": "Tech Notebook"}, {"name": "Ball Pen Set"}] }
    ]
  },
  "research": { label: "RESEARCH ENGINE", categories: [] }
};

let ENGINE_STATE = {
  cuisines_detected: [],
  items_detected: {},
  session_weights: {},
  active_filters: [],
  research_history: [],
  research_nodes: []
};

let RAW_DATA = FALLBACK_MENU;
let slideElements = [];
let currentIdx = 0;

async function boot(){ renderLobby(); initVoice(); initSwipeSystem(); }

/* =========================================
   PDF GENERATION ENGINE (kept compatible)
   ========================================= */
function sanitizeForPDF(text){
  return normalizeText(text).replace(/[^\x00-\xFF]/g, "");
}
async function generateResearchPDF() {
  if (ENGINE_STATE.research_nodes.length === 0) return showToast("NO RESEARCH TO EXPORT");
  showToast("GENERATING PDF...");

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 18;
    const contentWidth = pageWidth - (2 * margin);

    const addFooter = (pageNum, totalPages) => {
      doc.setFontSize(7);
      doc.setTextColor(150,150,150);
      doc.text(`viadecide.com | Page ${pageNum} of ${totalPages}`, pageWidth/2, pageHeight - 8, { align: 'center' });

      const now = new Date();
      const timestamp = now.toLocaleString('en-IN', { dateStyle:'medium', timeStyle:'short', timeZone:'Asia/Kolkata' });
      doc.setFontSize(6);
      doc.text(`Generated: ${timestamp}`, margin, pageHeight - 8);
    };

    let pageNum = 1;
    const totalPages = ENGINE_STATE.research_nodes.length + 1;

    doc.setFontSize(26);
    doc.setTextColor(255, 103, 31);
    doc.text("RESEARCH JOURNEY", pageWidth / 2, 52, { align: 'center' });

    doc.setFontSize(11);
    doc.setTextColor(0, 200, 100);
    doc.text("Powered by decide.engine", pageWidth / 2, 64, { align: 'center' });

    doc.setDrawColor(220,220,220);
    doc.setLineWidth(0.5);
    doc.rect(margin, 86, contentWidth, 34);

    doc.setFontSize(10);
    doc.setTextColor(60,60,60);
    doc.text(`Total Nodes: ${ENGINE_STATE.research_nodes.length}`, pageWidth / 2, 98, { align: 'center' });
    doc.text(`Primary Source: ${ENGINE_STATE.research_nodes[0]?.sourceName || 'Wikipedia'}`, pageWidth / 2, 106, { align: 'center' });
    doc.text(`Export Date: ${new Date().toLocaleDateString('en-IN')}`, pageWidth / 2, 114, { align: 'center' });

    doc.setDrawColor(255, 103, 31);
    doc.setFillColor(255, 250, 245);
    doc.roundedRect(margin, 138, contentWidth, 52, 3, 3, 'FD');

    doc.setFontSize(14);
    doc.setTextColor(255, 103, 31);
    doc.text("Continue Your Research", pageWidth / 2, 155, { align: 'center' });

    doc.setFontSize(9);
    doc.setTextColor(100,100,100);
    doc.text("Visit viadecide.com for intelligent decision tools", pageWidth / 2, 166, { align: 'center' });
    doc.text("Research â€¢ Compare â€¢ Decide", pageWidth / 2, 175, { align: 'center' });

    addFooter(pageNum, totalPages);

    ENGINE_STATE.research_nodes.forEach((node, index) => {
      doc.addPage();
      pageNum++;

      const title = sanitizeForPDF(node.title);
      const summaryRaw = sanitizeForPDF(node.summary);
      const takeaways = extractTakeaways(summaryRaw, 4).map(sanitizeForPDF);

      let y = 22;

      doc.setFillColor(0, 200, 100);
      doc.circle(margin + 7, y + 3, 7, 'F');
      doc.setFontSize(10);
      doc.setTextColor(255,255,255);
      doc.setFont(undefined, 'bold');
      doc.text(`${index + 1}`, margin + 7, y + 5, { align: 'center' });
      doc.setFont(undefined, 'normal');

      doc.setFontSize(16);
      doc.setTextColor(255, 103, 31);
      doc.setFont(undefined, 'bold');
      const titleLines = doc.splitTextToSize(title, contentWidth - 18);
      doc.text(titleLines, margin + 18, y);
      y += titleLines.length * 7 + 6;
      doc.setFont(undefined, 'normal');

      doc.setFontSize(8);
      doc.setTextColor(120,120,120);
      doc.text(`Source: ${node.sourceName}`, margin, y);
      y += 5;

      if (node.categories && node.categories.length > 0) {
        const cats = sanitizeForPDF(node.categories.slice(0,4).join(' â€¢ '));
        const catLines = doc.splitTextToSize(cats, contentWidth);
        doc.text(catLines, margin, y);
        y += catLines.length * 4.5 + 4;
      }

      doc.setDrawColor(220,220,220);
      doc.setLineWidth(0.5);
      doc.line(margin, y, pageWidth - margin, y);
      y += 8;

      doc.setFontSize(10);
      doc.setTextColor(40,40,40);
      doc.setFont(undefined, 'bold');
      doc.text("Key takeaways", margin, y);
      y += 6;
      doc.setFont(undefined, 'normal');

      doc.setFontSize(9.8);
      takeaways.forEach(t => {
        const lines = doc.splitTextToSize(`â€¢ ${t}`, contentWidth);
        lines.forEach(line => {
          if (y < pageHeight - 34) {
            doc.text(line, margin, y);
            y += 5.6;
          }
        });
        y += 1.5;
      });

      y += 3;
      doc.setDrawColor(235,235,235);
      doc.setLineWidth(0.3);
      doc.line(margin, y, pageWidth - margin, y);
      y += 8;

      doc.setFontSize(10);
      doc.setTextColor(40,40,40);
      doc.setFont(undefined, 'bold');
      doc.text("Summary", margin, y);
      y += 6;
      doc.setFont(undefined, 'normal');

      let summaryText = summaryRaw;
      const maxChars = 2400;
      if (summaryText.length > maxChars) {
        summaryText = summaryText.slice(0, maxChars);
        const lastPeriod = summaryText.lastIndexOf('.');
        if (lastPeriod > maxChars - 250) summaryText = summaryText.slice(0, lastPeriod + 1);
      }

      const paras = [];
      const sents = splitIntoSentences(summaryText);
      if (sents.length) {
        paras.push(sents.slice(0,1).join(" "));
        for (let i=1;i<sents.length;i+=3) paras.push(sents.slice(i,i+3).join(" "));
      } else paras.push(summaryText);

      const lineH = 5.6;
      paras.forEach(p => {
        const lines = doc.splitTextToSize(p, contentWidth);
        lines.forEach(line => {
          if (y < pageHeight - 34) {
            doc.text(line, margin, y);
            y += lineH;
          }
        });
        y += 3;
      });

      if (node.url) {
        const footerY = pageHeight - 22;
        doc.setDrawColor(220,220,220);
        doc.setLineWidth(0.3);
        doc.line(margin, footerY - 6, pageWidth - margin, footerY - 6);

        doc.setFontSize(8);
        doc.setTextColor(100,100,100);
        doc.text("Read full article:", margin, footerY);

        doc.setTextColor(0, 100, 200);
        doc.setFont(undefined, 'italic');
        const urlText = node.url.length > 64 ? node.url.substring(0, 64) + '...' : node.url;
        doc.textWithLink(urlText, margin, footerY + 5, { url: node.url });
        doc.setFont(undefined, 'normal');
      }

      addFooter(pageNum, totalPages);
    });

    const now = new Date();
    const dateStr = now.toISOString().slice(0, 10);
    const timeStr = now.toTimeString().slice(0, 5).replace(':', '');
    doc.save(`research-journey-${dateStr}-${timeStr}.pdf`);
    showToast("PDF DOWNLOADED!");
  } catch (error) {
    console.error('PDF generation error:', error);
    showToast("PDF GENERATION FAILED");
  }
}

/* =========================================
   UI LOGIC
   ========================================= */
function renderLobby() {
  const container = document.getElementById('master-container');
  container.innerHTML = "";
  const section = document.createElement('section');
  section.className = "main-slide active";

  let html = `<div class="slide-header">
    <span class="header-title">DECIDE OS v49.0</span>
    <span class="header-badge">RESEARCH</span>
  </div>
  <div class="lobby-container">
    <h1 style="text-align:center">SELECT DOMAIN</h1>
    <div style="display:grid; gap:14px;">`;

  for (let key in RAW_DATA) {
    const isSelected = ENGINE_STATE.cuisines_detected.includes(key) ? "selected" : "";
    html += `<button class="cuisine-btn ${isSelected}" onclick="toggleDomain('${key}', this)">${RAW_DATA[key].label}</button>`;
  }

  html += `</div>
    <button class="btn btn-auto btn-full" style="margin-top:18px" onclick="handleStart()">NEXT &rarr;</button>
  </div>`;

  section.innerHTML = html;
  container.appendChild(section);
  slideElements = [section];
  currentIdx = 0;
}

function toggleDomain(id, btn) {
  ENGINE_STATE.cuisines_detected = [id];
  document.querySelectorAll('.cuisine-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

function handleStart() {
  if (ENGINE_STATE.cuisines_detected.length === 0) return showToast("SELECT DOMAIN");
  const domain = ENGINE_STATE.cuisines_detected[0];
  if (domain === "research") {
    ENGINE_STATE.research_nodes = [];
    renderSearchSlide();
  } else {
    ENGINE_STATE.active_filters = [];
    renderSubLobby(domain);
  }
}

function renderSubLobby(domain) {
  const container = document.getElementById('master-container');
  while (container.children.length > 1) container.removeChild(container.lastChild);
  slideElements = [slideElements[0]];

  const section = document.createElement('section');
  section.className = "main-slide next";

  const title = domain === 'food' ? "AAJ KYA MANGVAAYEGE!" : "SELECT PRIORITY";
  const categories = RAW_DATA[domain].categories;

  let html = `<div class="slide-header"><span class="header-title">FILTER</span></div>
  <div class="lobby-container">
    <h1 style="text-align:center; text-transform:uppercase;">${title}</h1>
    <div style="display:grid; gap:14px;">`;

  categories.forEach((cat, idx) => {
    html += `<button class="cuisine-btn" id="filter-btn-${idx}" onclick="toggleFilter('${escapeHTML(cat.label)}', ${idx})">${escapeHTML(cat.label)}</button>`;
  });

  html += `</div><button class="btn btn-auto btn-full" style="margin-top:18px" onclick="startHunt()">HUNT &rarr;</button></div>`;

  section.innerHTML = html;
  container.appendChild(section);
  slideElements.push(section);
  goToSlide(1);
}

function toggleFilter(label, idx) {
  const btn = document.getElementById(`filter-btn-${idx}`);
  if (ENGINE_STATE.active_filters.includes(label)) {
    ENGINE_STATE.active_filters = ENGINE_STATE.active_filters.filter(x => x !== label);
    btn.classList.remove('selected');
  } else {
    ENGINE_STATE.active_filters.push(label);
    btn.classList.add('selected');
  }
}

function startHunt() {
  if (ENGINE_STATE.active_filters.length === 0) return showToast("SELECT AT LEAST ONE");
  ENGINE_STATE.session_weights = { camera:0.1, gaming:0.1, battery:0.1, ui:0.1, anc:0.1, sound:0.1, mic:0.1, latency:0.1, comfort:0.1, health:0.1, spice:0.1, speed:0.1, protein:0.1, heaviness:0.1, shareability:0.1 };
  buildDeck();
}

/* ðŸŸ¢ RESEARCH BRANCH */
function renderSearchSlide() {
  const container = document.getElementById('master-container');
  while (container.children.length > 1) container.removeChild(container.lastChild);
  slideElements = [slideElements[0]];

  const section = document.createElement('section');
  section.className = "main-slide next";

  let sourcesHtml = '';
  for (let key in WIKI_ENGINE.sources) {
    const src = WIKI_ENGINE.sources[key];
    const active = key === WIKI_ENGINE.activeSource ? 'active' : '';
    sourcesHtml += `<span class="source-chip ${active}" onclick="setSource('${key}', this)" title="${escapeHTML(src.description)}">${src.icon} ${escapeHTML(src.name)}</span>`;
  }

  section.innerHTML = `<div class="slide-header">
    <span class="header-title">RESEARCH ENGINE</span>
    <span class="header-badge">NODES: ${ENGINE_STATE.research_nodes.length}</span>
  </div>
  <div class="lobby-container">
    <div class="source-toggle">${sourcesHtml}</div>
    <h1>TOPIC?</h1>
    <input type="text" id="search-input" placeholder="Enter topic...">
    <button class="btn btn-auto btn-full" onclick="executeSearch()">SEARCH</button>
    ${ENGINE_STATE.research_nodes.length > 0 ? '<button class="btn btn-pdf btn-full" onclick="generateResearchPDF()">ðŸ“„ DOWNLOAD PDF</button>' : ''}
  </div>`;

  container.appendChild(section);
  slideElements.push(section);
  goToSlide(1);

  setTimeout(() => {
    const input = document.getElementById('search-input');
    if (input) {
      input.focus();
      input.addEventListener('keypress', (e) => { if (e.key === 'Enter') executeSearch(); });
    }
  }, 80);
}

function setSource(src, btn) {
  WIKI_ENGINE.activeSource = src;
  document.querySelectorAll('.source-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');

  const srcInfo = WIKI_ENGINE.sources[src];
  const input = document.getElementById('search-input');
  if (input) input.placeholder = `${srcInfo.icon} ${srcInfo.description}...`;
}

async function executeSearch() {
  const query = document.getElementById('search-input').value.trim();
  if (!query) return showToast("ENTER TOPIC");

  const container = document.getElementById('master-container');
  const loadingSlide = document.createElement('section');
  loadingSlide.className = "main-slide next";
  loadingSlide.innerHTML = `<div class="slide-header"><span class="header-title">SEARCHING...</span></div>
    <div class="sub-slide static">
      <div class="loading-indicator">
        <div class="loading-spinner"></div>
        <p>Searching ${escapeHTML(WIKI_ENGINE.sources[WIKI_ENGINE.activeSource].name)}...</p>
      </div>
    </div>`;
  container.appendChild(loadingSlide);
  slideElements.push(loadingSlide);
  goToSlide(slideElements.length - 1);

  try {
    const results = await WIKI_ENGINE.search(query);
    if (!results || results.length === 0) return showErrorSlide("No results found. Try different keywords or switch sources.");
    buildSearchResults(results);
  } catch (error) {
    console.error('Search error:', error);
    showErrorSlide("Search failed. Please check your connection and try again.");
  }
}

function buildSearchResults(results) {
  const container = document.getElementById('master-container');

  if (slideElements.length > 2) {
    container.removeChild(container.lastChild);
    slideElements.pop();
  }

  const resultsSlide = document.createElement('section');
  resultsSlide.className = "main-slide next";
  resultsSlide.dataset.mode = "research";

  let html = `<div class="slide-header">
    <span class="header-title">RESULTS</span>
    <span class="header-badge">${results.length} FOUND</span>
  </div><div class="carousel-viewport">`;

  results.forEach((result, i) => {
    html += `<div class="sub-slide ${i === 0 ? 'opt-active' : 'opt-hidden'}" data-val="${escapeHTML(result.title)}">
      <div class="role-label">${WIKI_ENGINE.sources[WIKI_ENGINE.activeSource].icon} ${escapeHTML(WIKI_ENGINE.sources[WIKI_ENGINE.activeSource].name)}</div>
      <h1>${escapeHTML(result.title)}</h1>
      <div class="primary-question">${escapeHTML(result.description || 'Swipe down to view details')}</div>
      <div class="nav-hint">
        <span>&larr; MORE RESULTS</span>
        <span style="color:var(--accent-go)">DOWN: OPEN</span>
      </div>
    </div>`;
  });

  html += `</div>`;
  resultsSlide.innerHTML = html;
  container.appendChild(resultsSlide);
  slideElements.push(resultsSlide);
  goToSlide(slideElements.length - 1);
}

async function loadArticleDetails(title) {
  const container = document.getElementById('master-container');

  const loadingSlide = document.createElement('section');
  loadingSlide.className = "main-slide next";
  loadingSlide.innerHTML = `<div class="slide-header"><span class="header-title">LOADING...</span></div>
    <div class="sub-slide static">
      <div class="loading-indicator">
        <div class="loading-spinner"></div>
        <p>Extracting context...</p>
      </div>
    </div>`;
  container.appendChild(loadingSlide);
  slideElements.push(loadingSlide);
  goToSlide(slideElements.length - 1);

  try {
    const context = await WIKI_ENGINE.getContext(title);
    if (!context) return showErrorSlide("Failed to load article. Please try again.");

    ENGINE_STATE.research_history.push({ title: context.title, source: context.source, timestamp: Date.now() });
    ENGINE_STATE.research_nodes.push(context);

    container.removeChild(container.lastChild);
    slideElements.pop();

    buildResearchDeck(context);
  } catch (error) {
    console.error('Load error:', error);
    showErrorSlide("Failed to load article. Please try again.");
  }
}

function buildResearchDeck(context) {
  const container = document.getElementById('master-container');

  const sumSlide = document.createElement('section');
  sumSlide.className = "main-slide next";
  sumSlide.dataset.mode = "research";

  let metaHtml = '';
  if (context.categories && context.categories.length > 0) {
    metaHtml = '<div class="wiki-meta">' + context.categories.map(cat => `<span class="meta-chip">${escapeHTML(cat)}</span>`).join('') + '</div>';
  }

  const wc = wordCount(context.summary);
  const rt = readingTimeMins(wc);
  const takeaways = extractTakeaways(context.summary, 4);
  const noSummary = isNoSummary(context.summary);

  const bookLink = generateAmazonBookLink(context.title);
  const thumbHTML = context.thumbnail
    ? `<div class="thumb"><img src="${context.thumbnail}" alt="thumb"></div>`
    : `<div class="thumb">NO IMG</div>`;

  sumSlide.innerHTML = `<div class="slide-header">
    <span class="header-title">ARTICLE</span>
    <span class="header-badge">${escapeHTML(context.sourceName)}</span>
  </div>
  <div class="carousel-viewport">
    <div class="sub-slide static article-view">

      <div class="context-panel">
        <div class="context-top">
          ${thumbHTML}
          <div class="context-title-wrap">
            <div class="context-kicker">${WIKI_ENGINE.sources[context.source].icon} ${escapeHTML(context.sourceName)}</div>
            <h1 style="margin:0 0 6px 0">${escapeHTML(context.title)}</h1>
            <div class="context-stats">
              <span class="stat-chip">${wc} words</span>
              <span class="stat-chip">~${rt} min read</span>
              <span class="stat-chip">${ENGINE_STATE.research_nodes.length} nodes saved</span>
            </div>
          </div>
        </div>
        ${metaHtml}
      </div>

      ${noSummary ? `
        <div class="takeaways">
          <div class="section-title">No intro summary found</div>
          <div style="color:#d6dde8; line-height:1.6; font-size:0.95rem;">
            This source doesnâ€™t provide an extract preview.
            <ul style="margin:10px 0 0 18px;">
              <li>Read the full article</li>
              <li>Watch a YouTube explanation</li>
              <li>Open the topic on Wikipedia (fallback)</li>
            </ul>
          </div>
        </div>
      ` : `
        <div class="takeaways">
          <div class="section-title">Key takeaways</div>
          <ul>${takeaways.map(t => `<li>${escapeHTML(t)}</li>`).join('')}</ul>
        </div>

        <div class="section-title">Summary</div>
        <div class="wiki-summary">${formatSummaryHTML(context.summary)}</div>
      `}

      <div class="action-bar">
        <div class="action-buttons">
          ${context.url ? `<button class="btn" onclick="window.open('${context.url}', '_blank')">FULL ARTICLE</button>` : `<button class="btn" onclick="openWikipedia('${escapeHTML(context.title)}')">OPEN ON WIKIPEDIA</button>`}
          <button class="btn btn-amazon" onclick="window.open('${bookLink}', '_blank')">ðŸ“š FIND BOOK</button>
          <button class="btn btn-yt" onclick="openYouTubeSearch('${context.title}')">â–¶ WATCH ON YOUTUBE</button>
          ${noSummary ? `<button class="btn btn-full" onclick="openWikipedia('${escapeHTML(context.title)}')">OPEN ON WIKIPEDIA (FALLBACK)</button>` : ``}
        </div>

        <button class="btn btn-pdf btn-full" onclick="generateResearchPDF()">ðŸ“„ DOWNLOAD PDF (${ENGINE_STATE.research_nodes.length} NODES)</button>

        <div class="nav-hint">
          <span>UP: BACK</span>
          <span style="color:var(--accent-go)">DOWN: ${context.links.length} LINKS</span>
        </div>
      </div>

    </div>
  </div>`;

  container.appendChild(sumSlide);
  slideElements.push(sumSlide);

  if (context.links && context.links.length > 0) {
    const linkSlide = document.createElement('section');
    linkSlide.className = "main-slide next";
    linkSlide.dataset.mode = "research";

    let html = `<div class="slide-header">
      <span class="header-title">RELATED TOPICS</span>
      <span class="header-badge">${context.links.length} LINKS</span>
    </div><div class="carousel-viewport">`;

    context.links.forEach((link, i) => {
      html += `<div class="sub-slide ${i === 0 ? 'opt-active' : 'opt-hidden'}" data-val="${escapeHTML(link.name)}">
        <div class="role-label">RELATED NODE</div>
        <h1>${escapeHTML(link.name)}</h1>
        <div class="primary-question">Swipe down to explore</div>
        <div class="nav-hint">
          <span>&larr; MORE</span>
          <span style="color:var(--accent-go)">DOWN: OPEN</span>
        </div>
      </div>`;
    });

    html += `</div>`;
    linkSlide.innerHTML = html;
    container.appendChild(linkSlide);
    slideElements.push(linkSlide);
  }

  goToSlide(slideElements.length - 2);
}

function showErrorSlide(message) {
  const container = document.getElementById('master-container');
  if (slideElements.length > 2 && slideElements[slideElements.length - 1].querySelector('.loading-indicator')) {
    container.removeChild(container.lastChild);
    slideElements.pop();
  }

  const errorSlide = document.createElement('section');
  errorSlide.className = "main-slide next";
  errorSlide.innerHTML = `<div class="slide-header"><span class="header-title">ERROR</span></div>
    <div class="sub-slide static article-view">
      <div class="error-box">${escapeHTML(message)}</div>
      <button class="btn btn-full" onclick="goToSlide(Math.max(0, currentIdx - 1))">GO BACK</button>
      <button class="btn btn-full" onclick="location.reload()">RESTART</button>
    </div>`;

  container.appendChild(errorSlide);
  slideElements.push(errorSlide);
  goToSlide(slideElements.length - 1);
}

/* ðŸ”´ STANDARD BRANCH (UNCHANGED) */
function buildDeck() {
  const container = document.getElementById('master-container');
  while(container.children.length > 2) container.removeChild(container.lastChild);
  slideElements = slideElements.slice(0, 2);

  const domain = ENGINE_STATE.cuisines_detected[0];
  const allCats = RAW_DATA[domain].categories;
  const targetCats = allCats.filter(c => ENGINE_STATE.active_filters.includes(c.label));

  let slides = [];
  targetCats.forEach(cat => slides.push({ type:'opt', title: cat.label, items: cat.items, catType: cat.type }));
  slides.push({ type:'final' });

  slides.forEach((s) => {
    const el = document.createElement('section');
    el.className = `main-slide next`;
    el.dataset.catType = s.catType;

    if (s.type === 'final') {
      el.innerHTML = `<div class="sub-slide static article-view"><div class="input-group" id="final-list"></div>
        <div class="final-actions">
          <button class="btn btn-amazon" id="btn-amazon" onclick="redirect('amazon')">AMAZON</button>
          <button class="btn btn-blinkit" id="btn-blinkit" onclick="redirect('blinkit')">BLINKIT</button>
          <button class="btn btn-zomato" id="btn-zomato" onclick="redirect('zomato')">ZOMATO</button>
          <button class="btn btn-auto btn-full" id="btn-auto" onclick="redirect('auto')">AUTO ROUTE</button>
          <button class="btn btn-wa btn-full" onclick="sendWa()">WHATSAPP</button>
          <button class="btn btn-full" onclick="location.reload()">HOME</button>
        </div></div>`;
    } else {
      let html = `<div class="slide-header"><span class="header-title">${escapeHTML(s.title)}</span></div><div class="carousel-viewport">`;
      s.items.forEach((item, i) => {
        html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${escapeHTML(item.name)}">
          <div class="role-label">OPTION</div><h1>${escapeHTML(item.name)}</h1>
          <div class="nav-hint"><span>UP: BACK</span><span style="color:var(--accent-go)">DOWN: SELECT</span></div></div>`;
      });
      html += `</div>`;
      el.innerHTML = html;
    }

    container.appendChild(el);
    slideElements.push(el);
  });

  goToSlide(2);
}

function resolvePlatform() {
  const text = Object.keys(ENGINE_STATE.items_detected).join(" ").toLowerCase();
  if (text.match(/iphone|samsung|phone|vivo|poco|iqoo|charger|buds|realme|xiaomi/)) return "amazon";
  if (text.match(/coke|chips|lays|milk|maggi|notebook|pen|eggs|bread|kurkure/)) return "blinkit";
  return "zomato";
}

/* =========================================
   UX PHYSICS ENGINE
   ========================================= */
let touchStartX = 0, touchStartY = 0;
let lockVerticalNav = false; // blocks slide vertical nav while scrolling in panels

function initSwipeSystem() {
  const doc = document;

  doc.addEventListener('touchstart', e => {
    const view = e.target.closest('.carousel-viewport');
    if(!view) return;

    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;

    // âœ… block vertical navigation if touch begins inside scroll panels
    lockVerticalNav = !!e.target.closest('.wiki-summary, .takeaways');
  }, {passive:true});

  doc.addEventListener('touchmove', e => {
    const view = e.target.closest('.carousel-viewport');
    if(!view) return;

    // âœ… allow native scroll inside panels (no depth-fill, no preventDefault)
    if (lockVerticalNav) return;

    const dy = e.touches[0].clientY - touchStartY;
    if(dy > 0 && Math.abs(dy) > Math.abs(e.touches[0].clientX - touchStartX)) {
      if (e.cancelable) e.preventDefault();
      document.getElementById('depth-fill').style.height = Math.min((dy/150)*100, 100) + '%';
    }
  }, {passive:false});

  doc.addEventListener('touchend', e => {
    const view = e.target.closest('.carousel-viewport');
    if(!view) return;

    const dx = e.changedTouches[0].clientX - touchStartX;
    const dy = e.changedTouches[0].clientY - touchStartY;
    document.getElementById('depth-fill').style.height = '0%';

    // âœ… ignore slide nav gestures for panel scroll interactions
    if (lockVerticalNav) {
      lockVerticalNav = false;
      return;
    }

    const mainSlide = view.closest('.main-slide');
    const mode = mainSlide.dataset.mode;
    const catType = mainSlide.dataset.catType;

    if(Math.abs(dy) > 80 && dy > 0) {
      const activeSub = view.querySelector('.sub-slide.opt-active') || view.querySelector('.sub-slide.static');
      if(!activeSub) return;
      const val = activeSub.dataset.val;

      if(mode === "research" && val) {
        loadArticleDetails(val);
      } else if (val) {
        ENGINE_STATE.items_detected[val] = {qty:1};
        if(catType && CATEGORY_VECTORS[catType]) {
          const vec = CATEGORY_VECTORS[catType];
          for(let k in vec) ENGINE_STATE.session_weights[k] = (ENGINE_STATE.session_weights[k]||0) + vec[k];
        }
        showToast("SELECTED");
        goToSlide(currentIdx + 1);
      } else {
        goToSlide(currentIdx + 1);
      }
    } else if (dy < -80) {
      showToast("BACK");
      goToSlide(currentIdx - 1);
    } else if(Math.abs(dx) > 60) {
      const slides = Array.from(view.querySelectorAll('.sub-slide'));
      if(slides.length <= 1) return;

      const currIdx = slides.findIndex(s => s.classList.contains('opt-active'));
      if(currIdx === -1) return;

      slides[currIdx].classList.replace('opt-active', 'opt-hidden');
      const nextIdx = (currIdx + (dx < 0 ? 1 : -1) + slides.length) % slides.length;
      slides[nextIdx].classList.replace('opt-hidden', 'opt-active');
    }
  });
}

function goToSlide(idx) {
  if(idx < 0 || idx >= slideElements.length) return;
  slideElements[currentIdx].classList.replace('active', idx>currentIdx?'prev':'next');
  currentIdx = idx;
  slideElements[currentIdx].className = "main-slide active";
  if(slideElements[currentIdx].querySelector('#final-list')) updateFinal();
}

function calculateVerdict() {
  const domain = ENGINE_STATE.cuisines_detected[0];
  if(domain === "research") return null;

  let DB = (domain === 'smartphones') ? PHONE_DATABASE : FOOD_DATABASE;
  let scores = [];

  for (let name in DB) {
    let item = DB[name];
    let score = 0;
    for(let attr in item.attr) {
      let w = ENGINE_STATE.session_weights[attr] || 0;
      score += item.attr[attr] * w;
    }
    if(ENGINE_STATE.items_detected[name]) score += 10;
    scores.push({name, score, price: item.price});
  }
  scores.sort((a, b) => b.score - a.score);
  return scores[0];
}

function updateFinal() {
  const list = document.getElementById('final-list');
  const winner = calculateVerdict();

  if (winner) {
    list.innerHTML = `
      <div class="context-panel" style="border-color: rgba(0,230,118,0.55)">
        <div class="context-kicker" style="color:#00e676">TOP RECOMMENDATION</div>
        <div style="font-size:1.35rem; font-weight:900; margin:6px 0 8px 0; color:#fff">${escapeHTML(winner.name)}</div>
        <div style="color:#a8b3c2">Est. Price: â‚¹${winner.price}</div>
      </div>`;
    ENGINE_STATE.items_detected = {};
    ENGINE_STATE.items_detected[winner.name] = {qty:1};
  } else {
    let html = "";
    for(let k in ENGINE_STATE.items_detected) html += `<div class="input-row"><span class="input-key">${escapeHTML(k)}</span><span class="input-val">READY</span></div>`;
    list.innerHTML = html || "Nothing Selected";
  }

  const mode = resolvePlatform();
  const a = document.getElementById('btn-amazon');
  const b = document.getElementById('btn-blinkit');
  const z = document.getElementById('btn-zomato');
  if(a) a.style.display = mode === 'amazon' ? 'block' : 'none';
  if(b) b.style.display = mode === 'blinkit' ? 'block' : 'none';
  if(z) z.style.display = mode === 'zomato' ? 'block' : 'none';
}

function forceCopy(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
  } else fallbackCopy(text);
}

function fallbackCopy(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.left = "-9999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try { document.execCommand('copy'); } catch (err) {}
  document.body.removeChild(textArea);
}

function redirect(type) {
  const item = Object.keys(ENGINE_STATE.items_detected)[0];
  if(!item) return showToast("NOTHING SELECTED");

  forceCopy(item);
  showToast("LINK COPIED");

  const autoMode = resolvePlatform();
  const mode = type === 'auto' ? autoMode : type;
  const target = DEEP_LINKS[mode];
  const q = encodeURIComponent(item);

  const start = Date.now();
  window.location.href = target.app(q);
  setTimeout(() => {
    if (Date.now() - start < 2500) window.location.href = target.web(q);
  }, 2000);
}

function sendWa() {
  const items = Object.keys(ENGINE_STATE.items_detected).join(', ');
  const text = encodeURIComponent(`DECISION: ${items}`);
  window.open(`https://wa.me/?text=${text}`);
}

function showToast(m) {
  const t = document.getElementById('toast');
  t.innerText = m;
  t.classList.add('visible');
  setTimeout(() => t.classList.remove('visible'), 1800);
}

function toggleListenMode() { showToast("VOICE: NOT IMPLEMENTED"); }
function initVoice() {}

boot();
</script>
</body>
</html>
